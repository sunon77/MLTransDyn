package bioinfo.simulation.ode;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;

import org.apache.commons.math3.exception.MaxCountExceededException;
import org.apache.commons.math3.ode.sampling.StepHandler;
import org.apache.commons.math3.ode.sampling.StepInterpolator;
import org.apache.commons.math3.util.Combinations;

/**
 * @author steven
 *
 */
public class LeukemiaODEOverrider implements DerivativeOverrider {

	private int _suppressIndex;
	private double _suppressPeriod;

	public LeukemiaODEOverrider(int index, double period) {
		_suppressIndex = index;
		_suppressPeriod = period;
	}
	
	public int getVariableIndex() {
		return _suppressIndex;
	}

	public boolean isOverrideDerivative(double t) {
		if (t < _suppressPeriod) {
			return true;
		} else { 
			return false;
		}
	}

	public double getDerivative(double t) {
		return 0;
	}
	
	private static final double[][] initialAttractors = new double[][] {
		{0.0869304054795343, 0.8670990423060454, 0.0017184085813569565, 7.244417532534386E-5, 0.944785828927017, 0.8594324558076426, 7.927039073154196E-5, 0.005681575244140503, 0.8848631587148462, 0.002721550477632118, 0.04006665491830135, 0.11133355212720192, 0.8780888126325654, 0.006020594236019476, 0.10654088181237126, 0.8663987344445725, 0.09759748439638707, 0.002138652313287376, 0.9598266059883996, 7.607396552439128E-6, 0.09864177008619555, 0.12115874228880813, 0.8646023222115257, 0.03884815863562128, 0.08402208270432408, 0.89496610554644, 0.05984437323304792, 0.036397699997612554, 0.9469971685090423, 0.12736189150227178, 0.020312624257117908, 0.956613058201653, 0.11476147785680434, 0.023229321324675672, 2.2043724445181765E-4, 7.244417532506794E-5, 0.0065042012160247435, 0.11162314274198495, 0.976398763081209, 0.04521110397215066, 0.10957367311592137, 0.8917091322987805, 0.9698411451908385, 0.013612370312878043, 0.002109788536917452, 0.8775763936580949, 0.9476047133344421, 0.9573608494149645, 0.8668876810332274, 4.446420028772582E-14, 0.9453265216662837, 0.8662899015221663, 0.06784099799583006, 0.0052379701497885294, 0.9597698486962065, 0.9615448408143332, 0.11880738451983688, 0.9159777138323955, 0.12751437196848842, 0.8932395764078613, 0.03415466141760918, 0.006744229107973539, 0.942175606861338, 0.8946768827147566, 0.11834177489324373, 3.748835028791353E-5, 0.893203977056645, 0.9475201535260456, -3.02949364149249E-61, 0.028053586703348586, 9.544571444691531E-4, 0.947654732576057, 0.9380281894517137, 0.896544593313344, 0.01934988161665977, 5.965728734316449E-7, 0.8971209767811277, 2.6937696978750454E-5, 7.679581196698884E-6, 0.8640311685913741, 0.120645636360319},
		{0.08637654297332698, 0.941996781423866, 0.09409156505690337, 6.578950302293806E-5, 0.9442472502537899, 0.054896543863913405, 1.8308053903178686E-4, 0.11723367740312267, 0.9376401095942279, 0.8885837406277926, 0.0550800898494642, 0.10975077018462318, 0.8924863090414076, 0.8771646642971895, 0.098394776097456, 0.9352035312966277, 0.10271993789085573, 0.00992947927593401, 0.941572448171577, 6.929759712561252E-6, 0.09680801183203774, 0.11643828133876585, 0.04799983572057636, 0.03739430827037236, 0.08375967885165654, 0.9387060027460774, 0.10009678444721513, 0.029597159615963643, 0.9462287531888726, 0.942629824574047, 0.8897384423274299, 0.9424434073435027, 0.10115486942229981, 0.8935799739500131, 0.0016236412494574281, 6.578950302275027E-5, 0.014257996747027452, 0.11016565453937321, 0.9765367443630502, 0.046312090839150284, 0.09677137469663352, 0.8762553775563579, 0.9708473612434619, 0.8755853528445122, 0.8641126057049998, 0.892143587014478, 0.9465450037588582, 0.9592725462334055, 0.09796377393234178, 1.1588746014808216E-12, 0.9436649874958162, 0.8896495395468007, 0.1280194286703183, 0.03007742663552722, 0.9588874284725911, 0.9598179392692345, 0.10754723426859004, 0.9244665059499746, 0.9306718040942602, 0.8941762788102603, 0.026850411135632583, 0.006501222997635432, 0.944612013985175, 0.924425634529191, 0.10418749234587875, 9.273460105494964E-5, 0.8939407961123972, 0.9510049777075139, -1.7708993445234935E-61, 0.0214933606173017, 0.0018944323997109613, 0.955278815381201, 0.8983960466564272, 0.954435819718523, 0.018738222659241126, 3.386229412276559E-6, 0.8857355225904229, 9.789176628073631E-5, 6.984812931305049E-6, 0.8591895185919756, 0.1196198494099439},
		{0.11829969823379202, 0.8641378278873146, 0.03465050911351625, 2.0171702452250625E-4, 0.880314370458976, 0.1215885507848906, 0.8523199034904253, 0.1216047626343013, 0.8659982808790596, 0.0015025761272558313, 0.1224866458413096, 0.1058738062136478, 0.1113934838984749, 0.8660530386341515, 0.0010494059449365882, 0.8590496365278283, 0.044542034026189364, 0.002417234505197974, 0.00373563141252548, 2.7517841379575028E-5, 0.13310961270514451, 0.8908116038716287, 0.8760692895372933, 0.8625589794458589, 0.11724668305175794, 0.048747773852670435, 0.06234332222322818, 0.002623940493797055, 0.04106107991533806, 0.8594717613559661, 0.02068132827047072, 0.13288151914180282, 0.8573940505976332, 0.8639910029163664, 0.905022439520155, 2.0171702450594848E-4, 0.0023838146702665902, 0.132259651187382, 0.1305988522556029, 0.9274696261316716, 0.8561742670337975, 0.03373215553179551, 7.608574934896926E-7, 0.012134681220197, 0.002797916733370007, 0.0011570750467507533, 0.8582663359756615, 0.12109512197831224, 0.8399590761641239, 2.6889875566978882E-8, 6.196624333918187E-8, 0.8484655726863906, 0.071190926077275, 0.005994996080304858, 4.565901740193903E-8, 0.001939438688237133, 0.06080795488297249, 0.10932626914260545, 0.12744938182616763, 0.003707920284159738, 0.8453077002455446, 0.8574189108675704, 0.022483705153986896, 0.9343356011992664, 0.8942092758355431, 0.0021533438457326, 1.1364607703039846E-4, 0.13191109227882802, 4.647554587082564E-66, 0.002243406753724962, 0.014904871950565104, 0.05741240422895038, 0.045437621996906714, 0.0032479896822678453, 0.027223465635528448, 0.8432919293387875, 0.003256241115908197, 0.0023294536342294285, 2.5788334442715473E-5, 0.8454960824333689, 0.9508655047186317},
		{0.09435641296437801, 0.8673309316823844, 0.029420656162236276, 1.1576554674151579E-5, 0.9429077749024494, 0.8817903639590478, 0.10891415228198449, 0.0026358341613302158, 0.8632690728686394, 0.00223690125510017, 0.039339597557585274, 0.0970913752506684, 0.9249895052227893, 0.0014571586512604124, 0.8697070647221249, 0.8671434648093636, 0.9413028681237384, 0.002620000409949854, 0.12857981292158027, 1.1640917219729223E-6, 0.10155592956757198, 0.11631978057325729, 0.8729414918693911, 0.03724994752867698, 0.05264445843891577, 0.885929695489455, 0.06404426158728482, 0.8534148042948969, 0.9430519174690745, 0.059923756780420806, 0.017117884760559147, 0.9608454315920324, 0.11782850147924141, 0.0030222358817258146, 0.08709020305006908, 1.157655467415139E-5, 0.0011369397656359615, 0.09729993125018097, 0.9632300814929817, 0.08705670303334165, 0.11237060318868002, 0.9436966358531849, 0.9676532742580055, 0.009319644101489213, 0.0028473124066729157, 0.8742677520726063, 0.9631794846563491, 0.9205498156890668, 0.8487312498190266, 2.8477970726694786E-14, 0.8580789406510064, 0.8666487165850961, 0.044473215395137905, 0.003494251378136564, 0.9071060304209806, 0.9272678296002054, 0.10374931080274195, 0.8578798561774107, 0.11972471615337292, 0.8926187478759728, 0.03558596253499076, 0.8676376427231637, 0.9402222568546739, 0.06444228406897605, 0.12063102000157837, 3.293828805906862E-5, 0.8926086042410802, 0.9606658439783695, -2.654149754993319E-54, 0.8682398491070082, 5.825924114200745E-4, 0.9434375465837587, 0.9361691279578104, 0.8977395057579853, 0.010500133419474273, 0.052828356200679306, 0.8980572245320939, 2.434462023719769E-5, 1.2337589016160067E-6, 0.8662658349587223, 0.12070011682614588},
		{0.08582317463644831, 0.021780239004225595, 0.0018051928894853, 1.5516072612359525E-23, 0.9432795472798144, 0.8521496653340702, 7.651862502312981E-5, 0.062053036268496536, 0.8837724940597661, 0.002924153843689526, 0.03937389975820548, 8.289303226793775E-4, 0.8760828136237729, 7.49543533111018E-4, 0.11190102964945131, 0.02393081514325708, 0.10275492525570971, 0.0023290863878469336, 0.9408217440316977, 3.416655827015214E-13, 0.09872282631686412, 0.12168582792370487, 0.8619144874685342, 0.03900626443569493, 8.378265101280013E-4, 0.8895177562755764, 0.0615742931046924, 0.03546680606883084, 0.9469953873321186, 0.12993469682327455, 0.02164913464072417, 0.9245296152912177, 0.11135174226232379, 0.042173500795444095, 0.0012130885767882853, 1.5516072612359525E-23, 0.006144776072591634, 0.002566792606364326, 0.9763494905110959, 0.0011816350709018485, 0.11134039755977247, 0.8698638854464672, 0.9694118445370928, 3.1455691877365297E-7, 0.002329393798657411, 0.875594605688264, 0.945116599704812, 0.9562862057394742, 0.8646297196373841, 3.0927746392646067E-13, 0.9435957403659618, 0.0064130959510062015, 0.13024315948570936, 0.023845535274209663, 0.9597720588916588, 0.9616404180826946, 0.11138222530403817, 0.9127031975553125, 0.13031115491966372, 0.8933335266792596, 0.034813560840294216, 0.006477682716097497, 0.9417728532177112, 0.8778488676652522, 0.11981239397330785, 3.3501169728865995E-5, 0.8930815587334473, 0.9301786222640316, 4.78193586740756E-52, 0.027076601050295208, 0.0012401358534240763, 0.9475734870736863, 0.9372373365656325, 0.8867560993367632, 1.1576938873720289E-8, 5.659201523991099E-7, 0.8872971034755406, 2.619085413242815E-5, 1.6518624443323314E-24, 1.3375446926593262E-4, 0.12130338847249363},
		{9.049401863346232E-4, 0.938418752703085, 0.05669203800484816, 2.7845717983019208E-5, 0.945807377833042, 0.10249324788958902, 5.89657479833627E-5, 0.12167713226570281, 0.9292943061134146, 0.11472286141023576, 0.03654363456917719, 0.11258052154724049, 0.8784982996775741, 0.871701767909642, 0.1026319537045577, 0.8913240410208079, 0.9266682479145306, 0.8631558920180588, 0.11584311025764116, 2.940307214053781E-6, 0.0950649981552783, 0.1154234906043104, 0.8778444205281121, 0.030082954300816898, 0.0040658292597694585, 0.8986804790702863, 0.8576058095951213, 0.03563243776913782, 0.9616682834483209, 0.13063822420206087, 0.890821397343738, 0.11756364611208067, 0.11404204758041589, 0.8791218382856792, 0.04750719473254447, 2.784571798301323E-5, 2.204366913801532E-4, 0.11468094709734157, 0.9797874013539009, 0.04751477616774978, 0.10887683966156267, 0.11438660026560704, 0.9579254402178186, 0.03024662017373079, 0.851324585280551, 0.8789050490185724, 0.9456336887490356, 0.956652436528554, 0.09434069971459177, 1.738319480906001E-13, 0.8658647968387535, 0.8758285833095174, 0.8983714517909426, 0.9313096379086017, 0.9347433618953195, 0.9370454212181274, 0.12221083575620459, 0.8594693705517034, 0.9343696123018794, 0.9398827594699958, 0.028089308647615746, 2.252301000698228E-4, 0.9429268068143912, 0.11443600572121564, 0.06058712786069684, 4.939913578838894E-5, 0.8934318377414466, 0.9591034403631327, -6.795449549093788E-42, 0.028242514409881625, 0.05012176720282761, 0.9616424968621866, 0.8977522318852602, 0.8605265383868447, 0.014068793035502784, 2.1778387165211245E-10, 0.015956308407016895, 2.8383143539244468E-5, 2.943293307910729E-6, 0.10597504798775645, 0.12255084284109997},
		{0.0932722774333643, 0.9414696390063231, 0.04114193147936846, 1.2805694454580362E-5, 0.942875853170335, 0.10760438367514519, 0.09572879501733245, 0.11028606084771742, 0.8629067255864692, 0.8867901588866568, 0.05491970416555586, 0.09842214379357472, 0.9300755604546035, 0.0015308401121739718, 0.8748052203207165, 0.9361170694893718, 0.9417243778954236, 0.015790371773168277, 0.12827100133942648, 1.2865339411552002E-6, 0.09671943626142278, 0.11179761837135047, 0.03673557412766852, 0.035815579004678064, 0.05246905509659095, 0.9303684390969719, 0.11706710948576345, 0.8571914185768761, 0.943166772493766, 0.12249272213509489, 0.8874190542547584, 0.9642388319923839, 0.10381741226115332, 0.020701246606787658, 0.08606728389071312, 1.2805694454580125E-5, 0.001150159006084028, 0.09872851054556331, 0.9676153084418898, 0.0864166293812169, 0.09927968951270158, 0.9412097722905208, 0.9692604515532075, 0.8747482412809505, 0.8665881662830148, 0.8895410094642007, 0.9634866759841049, 0.9294907018198472, 0.09715732931408708, 8.525424822564718E-13, 0.8584050789102255, 0.8899652578268702, 0.06510408646838202, 0.018456138423934558, 0.9112585935648088, 0.9274450527638237, 0.09644942104590848, 0.8569994256283628, 0.9237231567842034, 0.8935542237461982, 0.027738833056305857, 0.8684029901328167, 0.9432277371195339, 0.06773829251778035, 0.10611678008063036, 8.752353996978972E-5, 0.8935229478860766, 0.9634283222264145, 2.1742196223935636E-42, 0.8701925488488158, 7.063343649888279E-4, 0.9608275268375147, 0.8895315174548303, 0.9555631208181447, 0.01085932734364178, 0.05240450724382556, 0.8988317289372448, 8.988649760398644E-5, 1.3648769993673124E-6, 0.877156981291325, 0.11534181729319928},
		{0.09435650777085923, 0.8673309331137573, 0.02942066340082574, 1.1576797146083697E-5, 0.9429075946289608, 0.8817903804128415, 0.1089141255636047, 0.002635833296079396, 0.8632690744725436, 0.002236900228661046, 0.039339510438560245, 0.09709163768073353, 0.924988565207137, 0.001457159193767795, 0.8697067704151826, 0.8671434650052446, 0.9417783315830173, 0.0026200020531428106, 0.12753251852188224, 1.1640592576451445E-6, 0.1015559814014962, 0.11631976362186351, 0.8729414989382001, 0.03724998957397194, 0.052644464843943445, 0.8859297684374166, 0.06404427513605852, 0.8534146958449327, 0.9430517315843041, 0.059923765981013566, 0.01711787730261405, 0.9608537580457205, 0.1178284736438108, 0.0030222371302366467, 0.0870947156036407, 1.1576797146083518E-5, 0.001136943482035108, 0.09730019513551139, 0.9632300476839182, 0.08706121558663178, 0.11237057188649024, 0.9437346698864596, 0.9649661495097026, 0.00931971703027743, 0.0028473140086624086, 0.8742677791025192, 0.9631969311252768, 0.9205475038496004, 0.8487312568620325, 2.847405622131132E-14, 0.020267067261040394, 0.8666487221037478, 0.0444732206145652, 0.003494253296131995, 0.8547134932594752, 0.8802971216249422, 0.10374959017999658, 0.8578798596531955, 0.11972469842867046, 0.8926187498937307, 0.035585969322519846, 0.8676375968408235, 0.9402222633305746, 0.06444225248620575, 0.12063103034463696, 3.29376824922927E-5, 0.8926086062559896, 0.9606658815156985, -8.714683556173645E-53, 0.868239734614278, 5.825967198810857E-4, 0.9434373569661753, 0.9361688902552752, 0.8977418734438977, 0.010500206524410083, 0.05282762128204508, 0.8980595892595362, 2.434346955396177E-5, 1.2337853749999025E-6, 0.866265836288894, 0.12070010705634905},
		{0.09327235993282873, 0.9414696317206697, 0.04114194576980907, 1.2805946289233782E-5, 0.9428757091833654, 0.1076044057104711, 0.09572877799837867, 0.11028605559936491, 0.8629067083402748, 0.8867901334558846, 0.05491961809895164, 0.09842239111625369, 0.9300746821132899, 0.0015308408641440973, 0.8748049500482057, 0.9361170623937929, 0.9421874879913719, 0.01579038687239225, 0.1272466858543857, 1.2864991217638566E-6, 0.096719455492125, 0.1117976086298074, 0.03673564570306029, 0.03581561242669379, 0.0524690607987915, 0.9303684975891962, 0.11706714779812148, 0.8571913177537518, 0.9431666238551757, 0.12249275752832074, 0.8874190310386156, 0.9642461998859312, 0.10381739568344152, 0.020701262886135708, 0.08607157225749984, 1.2805946289233487E-5, 0.0011501622105439635, 0.09872875960655983, 0.9676152800175011, 0.08642093677427565, 0.09927967198514298, 0.9412463912854141, 0.9668776980506396, 0.8747482289128573, 0.8665880915465307, 0.8895410262060095, 0.9635033764337164, 0.9294887670227636, 0.097157347305015, 8.523971169344723E-13, 0.02013747885645515, 0.8899652615616197, 0.06510409700404243, 0.01845615485804907, 0.8588248475535561, 0.8823582350892681, 0.09644966342046023, 0.8569994005312052, 0.9237230766261219, 0.8935542268886308, 0.0277388360664854, 0.8684029489076269, 0.9432277460299159, 0.0677383014702458, 0.10611679122078874, 8.752219866490707E-5, 0.8935229510136816, 0.9634283632407069, 1.7314804403432175E-43, 0.8701924444869267, 7.063385568658471E-4, 0.9608274476546143, 0.8895309047757356, 0.9555634971235398, 0.010859398068925673, 0.05240386341100923, 0.8988337951031682, 8.988132378158622E-5, 1.3649043933472244E-6, 0.8771569776318429, 0.11534180954639332},
		{0.09433994222849121, 0.017222690321139784, 0.029478842584145803, 8.880158838216532E-24, 0.9423864340554932, 0.8797462488722138, 0.1097457359685384, 0.021873251814427782, 0.8628322618543964, 0.002281673846946983, 0.03710239673532977, 9.385938932285186E-4, 0.9247160081415815, 1.1533448538318734E-6, 0.8694560130285246, 0.017273988287376044, 0.9407659861797916, 0.002621781719051329, 0.1285436731784542, 2.080336629420832E-14, 0.10168483862313214, 0.11660189540584737, 0.8721693814051771, 0.03729192458339288, 5.121333558538513E-4, 0.8837418652806874, 0.0640588089080384, 0.8531841902482351, 0.9430948916586533, 0.06010745919602089, 0.01742029068356231, 0.9535995765793195, 0.11308503526242403, 0.004865767122851566, 0.08716510161850757, 8.880158838216533E-24, 0.0011367369816032802, 0.0025143805532043704, 0.9629272446701176, 0.0016213143208987162, 0.11309643400314712, 0.9414658912888445, 0.9678609918297506, 2.5623317223728696E-4, 0.002876665004002884, 0.873450098893745, 0.9628636703479908, 0.9201967824890612, 0.848043193302721, 1.667329134860157E-14, 0.858053846789163, 0.008372777865677814, 0.06477580871740185, 0.005318171288153276, 0.9126897941164666, 0.9334319545121401, 0.09708572873565358, 0.8568236455554278, 0.12044501998145013, 0.8926038203486765, 0.03584019143520949, 0.8675854307501822, 0.9401041175331745, 0.0644635098284367, 0.12134630124398392, 2.743555919756015E-5, 0.89257246273341, 0.9544086580486862, 9.75637116574387E-54, 0.8681058319434946, 1.5907552004867885E-4, 0.9433818418764051, 0.9359003309384925, 0.8957343966290588, 9.611849170452396E-9, 0.0534859166917909, 0.8959622613606995, 2.0495112127316996E-5, 9.47797215210448E-25, 5.139617558822216E-5, 0.12097227539804944},
		{9.049912575457202E-4, 0.9384187515817568, 0.05669203712355019, 2.7845815507066897E-5, 0.9458072539388542, 0.10249325070128544, 5.8964962231481546E-5, 0.12167713059885252, 0.929294304675526, 0.1147228634425443, 0.03654347238432142, 0.11258056608024325, 0.878498166596206, 0.8717017650114162, 0.10263195282804083, 0.891324038190623, 0.927464094779831, 0.8631558935379517, 0.11363679981654362, 2.9398129591150583E-6, 0.09506501355368792, 0.11542348853650242, 0.8778444147580523, 0.030082958563169386, 0.004065831045889384, 0.898680478001447, 0.8576058120276016, 0.03563246079296747, 0.9616682237968335, 0.13063822252605378, 0.890821394277213, 0.11756589003730777, 0.11404204704345566, 0.8791218321167639, 0.0475094341314465, 2.7845815507060893E-5, 2.2043669660497305E-4, 0.1146809925185218, 0.9797873803047653, 0.0475170159316899, 0.10887683790863667, 0.11439445139466808, 0.9537877098875479, 0.03024663610511263, 0.8513245726298226, 0.8789050486735509, 0.9456942724872976, 0.9566507983122289, 0.09434070213881175, 1.7382554525735878E-13, 0.014476004476693479, 0.8758285884150253, 0.8983714338153964, 0.9313096363001511, 0.8907634591089297, 0.896244707658261, 0.12221088385309, 0.8594693649086148, 0.9343696036787842, 0.9398827583374263, 0.02808931033997545, 2.2523057701855605E-4, 0.9429268109257816, 0.11443599450981276, 0.060587128694430614, 4.9398520035411133E-5, 0.8934318389756917, 0.95910343611715, 5.4289216221153644E-42, 0.02824253429938043, 0.05012176851465283, 0.9616424356119967, 0.8977517619590785, 0.8605265559880193, 0.014068809416715457, 2.1778449108416455E-10, 0.01595720802433435, 2.8382761478201526E-5, 2.9433046513758403E-6, 0.10597505334403078, 0.12255084296797703},
		{0.11676494358528566, 0.8671086224500745, 0.03295184815890218, 4.5731897852952907E-4, 0.0020813206877959406, 1.6306837139544003E-4, 0.9177656634264171, 0.021893357717849324, 3.42831794659875E-7, 0.0026829537745708307, 0.9535543973389081, 0.12857407207023436, 0.08911963490830402, 0.01559127824783346, 6.578443905893378E-4, 0.8664698619275653, 0.010141873566803206, 0.01721668774942489, 0.001650357867169114, 0.0020653764077232036, 0.118032142470943, 1.396499958954195E-4, 0.003151331934643227, 3.5091664632632675E-8, 0.11656431850313104, 0.04087062898011035, 0.12054909485548418, 0.01617776516427768, 3.2608003564851964E-4, 0.021310226703572403, 0.01926843788601051, 0.09928903845387095, 0.86559017146323, 0.0032485814355707812, 0.9550538890430603, 4.573189780921307E-4, 0.0021942945379185806, 0.1271167529789649, 0.004283183226919355, 0.953111211316952, 0.8623457483463044, 0.0021525406458312813, 2.690622345666977E-8, 0.021155711526506905, 0.017196820080260244, 6.822406289785254E-4, 0.8635139940991202, 0.002167686538037741, 0.8466028178325317, 0.09043750352690702, 4.6286726377659015E-9, 0.08965977239035013, 0.06813004064491063, 0.020261663473645348, 1.372541380844912E-8, 8.009727861267373E-9, 0.0015178668802037735, 1.751167999562947E-5, 0.12448149271759094, 0.00315242466189134, 0.8518667124453386, 0.8632315529608703, 7.063091108816338E-5, 0.018863817993866498, 0.8309987357982478, 0.09203070161079772, 3.5235818430050773E-12, 0.0014950335355379922, 4.586302353690989E-74, 3.781731787803381E-8, 0.023824435065573253, 0.019358277547980248, 0.02081268172557793, 6.146427356358161E-4, 0.035766161726820636, 0.8570671729852986, 0.0013496423554051824, 0.8965900070931301, 4.5731798173796035E-4, 0.8639362080527588, 1.3465763893968718E-4},
		{9.049402516296959E-4, 0.938418752709056, 0.05669203779271498, 2.7845718266901243E-5, 0.9458073778063871, 0.10249324734858792, 5.8965746165027046E-5, 0.1216771315453496, 0.9292943061517909, 0.1147228625044418, 0.03654363470651891, 0.11258052161764873, 0.8784982998502605, 0.8717017666966461, 0.10263195427608282, 0.891324041574532, 0.9266682467871217, 0.8631558933478647, 0.1158431092476257, 0.7985573721429327, 0.09506499819659806, 0.11542349074555337, 0.8778444215439339, 0.03008295439906871, 0.004065829439966131, 0.8986804789240697, 0.8576058084565839, 0.03563243710632496, 0.961668283566286, 0.13063822297663713, 0.8908213978789409, 0.11756364507647052, 0.11404204746785795, 0.8791218393761764, 0.04750719491884703, 2.7845718266895233E-5, 2.204366957147597E-4, 0.11468094725659335, 0.979787401380921, 0.04751477635472041, 0.10887683952317018, 0.0707320948685603, 0.9579254403529003, 0.030246619067022126, 0.8513245866045175, 0.8789050491694941, 0.1552165318848422, 0.9566524364884543, 0.09434069941709992, 0.8063409563193948, 0.8658647968631109, 0.875828582659856, 0.8983714508446711, 0.9313096385880081, 0.9347433618787849, 0.9370454212685454, 0.12221083594165412, 0.8594693690598858, 0.9343696117778505, 0.9398827597232878, 0.02808930864748619, 2.252301396668527E-4, 0.942926806854675, 0.11443600472504588, 0.06058712753332173, 4.939913443613747E-5, 0.8934318377085801, 0.9591034405397343, 7.34878978597403E-61, 0.028242513755067682, 0.0501217672635707, 0.9616424968717431, 0.1473572584741167, 0.8605265369635396, 0.014068792989285237, 2.1778370670231587E-10, 0.015956309622072114, 2.8402029431117164E-5, 2.9432933370322246E-6, 0.10597504695870466, 0.1225508430336936},
		{0.08582317465513835, 0.0217802394297863, 0.001805192912561267, 1.551606607942555E-23, 0.9432795472824927, 0.8521496646007486, 7.65186246584861E-5, 0.062053037456169004, 0.8837724939331317, 0.002924153910311272, 0.039373899794665754, 8.28930321004599E-4, 0.8760828136275832, 7.495434562193428E-4, 0.11190102943511418, 0.02393081534404502, 0.10275492505848509, 0.0023290864175727613, 0.9408217436396829, 0.7957491019038682, 0.09872282632384975, 0.12168582793313253, 0.861914488010511, 0.03900626443624042, 8.378264865542373E-4, 0.8895177562703175, 0.06157429295459749, 0.03546680622146518, 0.9469953873367855, 0.12993469632227614, 0.02164913507217135, 0.9245296148798815, 0.11135174225980468, 0.04217350162046197, 0.0012130885987529949, 1.5516066079425547E-23, 0.006144776062909499, 0.0025667926044498457, 0.9763494905110055, 0.001181635093076005, 0.11134039755667113, 0.1467640606352401, 0.9694118445166351, 3.145568849919439E-7, 0.002329393828349547, 0.8755946056916437, 0.15650694959105987, 0.956286205734906, 0.8646297191331821, 0.780548917478243, 0.9435957404164005, 0.006413095937943679, 0.13024315897418604, 0.023845535736582726, 0.9597720589170958, 0.9616404181084653, 0.11138222525806564, 0.9127031977679808, 0.1303111544138561, 0.8933335266825752, 0.03481356085380896, 0.006477682702826675, 0.9417728532212383, 0.8778488672952192, 0.11981239396777668, 3.350116953221028E-5, 0.8930815587315709, 0.930178622269693, -2.063471745397848E-68, 0.027076601211954016, 0.0012401358784264627, 0.9475734870755389, 0.15520217996725055, 0.8867560995727263, 1.1576939802537695E-8, 5.659201566641292E-7, 0.8872971037090284, 3.6438130675988706E-5, 1.6518617488491743E-24, 1.3375446334910367E-4, 0.12130338847266135},
		{0.09434007748144635, 0.017222682097234047, 0.02947884930514354, 8.880685157046044E-24, 0.9423862562496919, 0.8797462737937147, 0.1097456971523472, 0.021873246028040902, 0.8628322629775581, 0.0022816727488581276, 0.037102124860401965, 9.386004285302288E-4, 0.924715056741014, 1.1533461235383345E-6, 0.8694557189809728, 0.017273980029695934, 0.9412478324417335, 0.002621783621537169, 0.12748137156910744, 2.0799824391209263E-14, 0.10168489254141783, 0.11660187324047648, 0.872169393020327, 0.03729196680364925, 5.121355643384693E-4, 0.8837419771331788, 0.06405882290113313, 0.8531840837788094, 0.9430947101937089, 0.06010746721668793, 0.017420282736339672, 0.9536117873539198, 0.11308499034837716, 0.00486576946552552, 0.0871696824454359, 8.880685157046049E-24, 0.0011367421158118198, 0.0025143894908012535, 0.9629272145934196, 0.0016213983596111445, 0.11309638906907842, 0.9415051710267119, 0.9651520786886902, 2.562333525963216E-4, 0.002876667084758942, 0.8734501409304424, 0.9628817724570254, 0.9201944382775873, 0.8480431996859972, 1.6669957815215822E-14, 0.020242654857488343, 0.00837281336728339, 0.0647758188045472, 0.005318174551075601, 0.8599740416059333, 0.8860737661029584, 0.09708599366904534, 0.8568236513127322, 0.12044499757126019, 0.8926038254988808, 0.035840197986071444, 0.8675853842375776, 0.9401041344131802, 0.06446347736540836, 0.12134631698989859, 2.743446430493602E-5, 0.8925724678706322, 0.954408723549721, 1.7057472934389055E-53, 0.8681057172944294, 1.5907560754537035E-4, 0.9433816498868015, 0.9359000890549642, 0.8957379642853661, 9.612039399670995E-9, 0.053484825201105965, 0.895965819703342, 2.049380247171877E-5, 9.478538700653745E-25, 5.1396073195765286E-5, 0.12097226038300853},
		{0.1150500891516812, 0.01806927683939379, 0.031985964123358725, 9.730223661919273E-20, 0.0016366063985339546, 6.0544464929203035E-5, 0.9364330065380123, 0.03669465471638756, 7.268348942707096E-5, 0.0026038903014201182, 0.9363023212471132, 0.002329385417967705, 0.0896234914703977, 7.277057181914914E-5, 0.0017611048475745573, 0.01848472341136175, 1.591298886947777E-7, 0.016102653016487185, 0.001022358832026488, 0.0019988482620985817, 0.11536407448698816, 1.1347129240140779E-4, 0.01894465387133562, 3.3730107642787247E-7, 0.00205745921682141, 7.173853682404808E-4, 0.11784627914446416, 0.015121782259375206, 0.002058026609607192, 0.03522704521835871, 0.018323842721929638, 6.8775065490711446E-6, 0.01900688368412372, 0.019371166716805686, 0.9537133689252195, 9.730223661919279E-20, 0.0020319868032730314, 0.11523094416279124, 0.0017542420714864084, 0.9341214233937393, 0.8670032467112748, 3.094254814122476E-8, 4.2634680524731095E-16, 3.2744469911184863E-4, 0.01641951448313982, 3.691965059735654E-9, 0.8670021473659221, 0.0019620760327357114, 0.851388912077801, 0.09058505465277561, 1.104518956155241E-9, 0.001635657641127345, 0.12454054930253151, 0.034453466836569795, 2.614039287602278E-6, 4.966863999246466E-9, 0.00293404750923364, 1.5428748996564015E-5, 0.12240211371101228, 0.018950610375504946, 0.8451644288901312, 0.8672710392398748, 6.263584229123418E-9, 0.01766657863798316, 0.8172616858673172, 0.09213751142598196, 2.4573648512687297E-24, 0.002515266121564415, 1.8190722203074102E-62, 3.072017640750627E-7, 0.018950731000644552, 0.018002608967509416, 2.0193030247520628E-7, 2.9151159760069094E-6, 2.1348831810168972E-7, 0.8670788594004446, 4.622566167192261E-16, 0.8913405725586151, 9.730223235383436E-20, 6.192868426399674E-5, 4.3695715328420263E-4},
		{0.11505006448578099, 1.33493583811974E-8, 0.015034160916454315, 3.591697098509754E-13, 0.001635880074691257, 1.5912109795609987E-7, 0.9364018538450573, 0.019012841961951948, 6.872429027897584E-5, 3.399097198039543E-5, 0.9362981350345738, 0.014875132305288872, 0.09412491061269158, 6.880511226271826E-5, 0.0029225189361470434, 1.0164629905928802E-4, 1.5912567226896112E-7, 1.2723803003917875E-15, 4.085366830904336E-6, 0.002309942588624914, 0.11536448593187061, 4.616296658939573E-23, 0.019011284986252486, 6.365402594752757E-5, 0.0020069401212838528, 9.660897604888682E-4, 5.029668004246065E-6, 0.015184060631146325, 0.002057997414580256, 0.01866599504319013, 3.3993307576824176E-5, 3.579161576291839E-6, 0.018981916882513186, 0.01901282994775482, 0.9364470498844708, 3.5916970985097535E-13, 0.0019942533129793665, 0.11521335692590855, 3.5875184217694928E-6, 0.8915986210106123, 0.8670033401275152, 3.5841229598711184E-6, 2.1398511834564047E-16, 6.689080267218274E-5, 3.3978851995023054E-5, 9.016795931072615E-9, 0.8670026894302673, 7.4608814547109536E-6, 0.8670022025314467, 0.09513662512114326, 7.401845800431017E-17, 0.001629021609276203, 0.12453971870037303, 0.018950239566544395, 2.776263454741716E-6, 2.966986478681766E-16, 0.018576196241129123, 6.409737146905845E-5, 0.0011007845839238306, 0.01895023956654322, 4.896073827527378E-6, 0.8672710397313773, 9.79224753280962E-10, 1.3090512354753389E-8, 0.00787698040549114, 0.09676458871938894, 9.389632633891375E-27, 0.002515242359850423, -1.7875848228520978E-50, 6.434726794546838E-5, 0.01898191705366246, 1.3338407662184916E-8, 3.2913064936194884E-5, 8.530430133296678E-14, 3.299389939490156E-5, 0.8670788584714864, 4.58487958653927E-16, 0.8913386803529775, 3.591696941273072E-13, 1.0302368430095748E-11, 6.50316915031594E-5},
		{9.049912973906534E-4, 0.938418751595646, 0.05669203700548478, 2.784581583964143E-5, 0.9458072538835205, 0.10249324988906822, 5.89649612564436E-5, 0.12167712949590828, 0.9292943048357228, 0.11472286417916279, 0.036543472466575536, 0.11258056607596884, 0.8784981667302896, 0.8717017642593147, 0.10263195320756219, 0.8913240390321955, 0.9274640941105127, 0.863155894453053, 0.11363679902355416, 0.7985421165757446, 0.09506501361859444, 0.11542348864773448, 0.8778444155910624, 0.03008295863829686, 0.004065831249611375, 0.8986804778709462, 0.8576058111313685, 0.03563246025354411, 0.961668223875797, 0.13063822169237735, 0.890821395099419, 0.11756588919880942, 0.11404204695115178, 0.8791218329897715, 0.0475094342619836, 2.7845815839635437E-5, 2.2043669834452223E-4, 0.11468099264398687, 0.979787380320428, 0.04751701606268703, 0.10887683779288965, 0.07073849764549411, 0.9537877100688801, 0.030246635514791214, 0.8513245735111701, 0.8789050487953333, 0.15523392242840742, 0.9566507983664151, 0.09434070158567097, 0.8063289615196346, 0.014476005137955229, 0.8758285874224291, 0.8983714328197385, 0.9313096368072767, 0.8907634590203747, 0.8962447076149195, 0.12221088401465659, 0.8594693638624448, 0.934369602877758, 0.9398827585413664, 0.028089310325964994, 2.252306198026417E-4, 0.9429268109557835, 0.11443599371848594, 0.06058712843055425, 4.939851934340493E-5, 0.8934318389509018, 0.9591034363070534, 2.990074507186617E-70, 0.028242533776538403, 0.05012176856152776, 0.9616424356664413, 0.147364250163332, 0.8605265549760186, 0.014068809422297636, 2.17784229862191E-10, 0.01595720877871173, 2.840165097666316E-5, 2.9433046851118734E-6, 0.10597505245165029, 0.1225508431157102}
		}; 

	// S1 should be the leukemia state, while S12 and S14 should be normal differentiated cell states.
	private static String[] nameMapping = new String[] {"S5", "S4", "S12", "S1", "S6", "S7", "S3", "S10", "S9", "S2", "S14", "S8", "S16", "S18", "S11", "S13", "S15", "S17"};
	
	public static void main(String[] args) {
/*		HashSet<Integer> targetStates = new HashSet<Integer>();
		targetStates.add(2);
		targetStates.add(10);
		scanTransitions(3, targetStates, 1, 0);
		scanTransitions(3, targetStates, 2, 0); 
		analyzeInhibition(initialAttractors, new int[] {62, 67}, 0);
		analyzeInhibition(initialAttractors, new int[] {62, 67}, 0.2);
		analyzeInhibition(initialAttractors, new int[] {62, 67}, 0.3);
		analyzeInhibition(initialAttractors, new int[] {31, 71}, 0);
		analyzeInhibition(initialAttractors, new int[] {31, 71}, 0.2);
		analyzeInhibition(initialAttractors, new int[] {31, 71}, 0.3);
		*/
//		for (int i = 0; i < 18; i++) {
			analyzeInhibitionWithNoises(initialAttractors, 3, new int[] {62, 67}, 
					null, //new int[] {0, 1, 2, 3, 4, 7, 8, 9, 10, 11, 15, 17, 18, 19, 20, 22, 24, 26, 30, 35, 36, 37, 43, 44, 46, 48, 49, 51, 52, 53, 56, 58, 61, 62, 65, 67, 68, 70, 74, 77, 78, 79},
					0.2, 1, 1);
			analyzeInhibitionWithNoises(initialAttractors, 3, new int[] {62, 67}, 
					new int[] {0, 1, 2, 3, 4, 7, 8, 9, 10, 11, 15, 17, 18, 19, 20, 22, 24, 26, 30, 35, 36, 37, 43, 44, 46, 48, 49, 51, 52, 53, 56, 58, 61, 62, 65, 67, 68, 70, 74, 77, 78, 79},
					0.2, 1, 1);
//		}
	}

	private static final int INVALID_STATE = -1;
	private static final double TOTAL_PERIOD = 60;
	
	/**
	 * @param attractors
	 * @param attractorInex
	 * @param inhibitorIndex
	 * @return the target attractor index
	 */
	private static int analyzeSingleSimulation(double[][] attractors, int startAttractorIndex, int[] inhibitorIndexes, int[] keepValueIndexes, double percent, NoiseGenerator noise) {
		// Use the first data to do the analyzing
		double[] initialValue = new double[attractors[0].length];
		for (int i = 0; i < LeukemiaODE.GENE_COUNT; i++) {
			initialValue[i] = attractors[startAttractorIndex][i];
		}
		
		CellSimulationBase ode = new LeukemiaODE();
		if (inhibitorIndexes != null && inhibitorIndexes.length > 0) {
			for (int index : inhibitorIndexes) {
				initialValue[index] *= percent; // Reset this dimension;
				ode.addOverrider(new LeukemiaODEOverrider(index, TOTAL_PERIOD / 2));
			}
		}
		
		if (keepValueIndexes != null && keepValueIndexes.length > 0) {
			for (int index : keepValueIndexes) {
				ode.addOverrider(new LeukemiaODEOverrider(index, TOTAL_PERIOD / 2));
			}
		}
		
		if (noise != null) {
			ode.setNoiseGenerator(noise);
		}
		
		CellSimulationBase.runSimulation(ode, initialValue, TOTAL_PERIOD, new MyStepHandler());
		
		double maxTolerance = 0.001;
		if (noise != null) {
			maxTolerance = -1; // We just care its polarity.
		}
		return attractorWhomIam(initialValue, attractors, maxTolerance);
	}
	

	static class MyStepHandler implements StepHandler {
		public void init(double t0, double[] y0, double t) {
			System.out.print("Time");
			for (String name : LeukemiaODE.index2name) {
				System.out.print(", " + name);
			}
			System.out.println();
		}
		
		static int counter = 0;
		
		public void handleStep(StepInterpolator interpolator, boolean isLast)
				throws MaxCountExceededException {
//			if (counter++ % 10 != 0) {
//				return;
//			}
			
//			if (interpolator.getCurrentTime() > 30) {
//				return;
//			}
			
			// TODO Auto-generated method stub
			StringBuilder sb = new StringBuilder();
			sb.append((int)(interpolator.getCurrentTime()*1000));
			for (int i = 0; i < interpolator.getInterpolatedState().length; i++) {
				sb.append(", ").append((int)(interpolator.getInterpolatedState()[i]*1000));
			}
			
			System.out.println(sb.toString());
		}
	}
	
	/**
	 * Given start state, get which transition it could get
	 * @param startAttractorIndex
	 * @param expectedEndIndexes
	 * @param overriddenCount
	 * @param percent
	 */
	private static void scanTransitions(int startAttractorIndex, HashSet<Integer> expectedEndIndexes, int overriddenCount, double percent) {
		System.out.println(">>>> Suppress " + Integer.toString(overriddenCount) + " genes in percent " + Double.toString(percent)+ " >>>>");
		// Get the list of candidates
		List<Integer> candidatesIndex = new ArrayList<Integer>();
		for (int j = 0; j < initialAttractors[startAttractorIndex].length; j++) {
			if (initialAttractors[startAttractorIndex][j] > 0.5) {
				candidatesIndex.add(j);
			}
		}
		
		if (candidatesIndex.size() >= overriddenCount) {
			Combinations generator = new Combinations(candidatesIndex.size(), overriddenCount);
			Iterator<int[]> iter = generator.iterator();
			while (iter.hasNext()) {
				int[] comb = iter.next();
				int[] suppressIndexes = new int[overriddenCount];
				for (int it = 0; it < overriddenCount; it++) {
					suppressIndexes[it] = candidatesIndex.get(comb[it]);
				}
				int newIndex = analyzeSingleSimulation(initialAttractors, startAttractorIndex, suppressIndexes, null, percent, null);
				if (newIndex == -1) {
					System.err.println("Something wrong!");
				}
				
				if (newIndex != -1 && (expectedEndIndexes == null || expectedEndIndexes.contains(newIndex))) {
					printTransition(startAttractorIndex, newIndex, suppressIndexes);
				}
			}
		}
	}
	
	private static void printTransition(int startAttractorIndex, int endAttractorIndex, int[] inhibitedIndexes) {
		StringBuilder sb = new StringBuilder();
		sb.append(startAttractorIndex).append(':').append(nameMapping[startAttractorIndex]).append('\t');
		if (inhibitedIndexes != null && inhibitedIndexes.length > 0) {
			boolean firstOne = true;
			for (int index : inhibitedIndexes) {
				if (firstOne) {
					firstOne = false;
				} else {
					sb.append(',');
				}
				sb.append(index).append(':').append(LeukemiaODE.index2name[index]);
			}
		}
		sb.append('\t').append(endAttractorIndex).append(':').append(nameMapping[endAttractorIndex]);
		System.out.println(sb.toString());
	}
	
	/**
	 * Given some inhibitions, determine which state transitions are triggered
	 * @param attractors
	 * @param inhibitorIndexes
	 * @param percent
	 */
	private static void analyzeInhibition(double[][] attractors, int[] inhibitorIndexes, double percent) {
		System.out.println(">>>> percent " + Double.toString(percent));
		for (int i = 0; i < attractors.length; i++) {
			int newIndex = analyzeSingleSimulation(initialAttractors, i, inhibitorIndexes, null, percent, null);
			if (newIndex != INVALID_STATE) {
				printTransition(i, newIndex, inhibitorIndexes);
			}
		}
	}
	
	private static void analyzeInhibitionWithNoises(double[][] attractors, int startState, int[] inhibitorIndexes, int[] keepValueIndexes, double percent, int count, int noiseScale) {
		System.out.println(">>>> percent " + Double.toString(percent));
		for (int i = 0; i < count; i++) {
			int newIndex = analyzeSingleSimulation(initialAttractors, startState, inhibitorIndexes, keepValueIndexes, percent, noiseScale <= 1 ? null : new MyNoiseGenerator(noiseScale, (int)TOTAL_PERIOD, 100, LeukemiaODE.GENE_COUNT));
			if (newIndex != INVALID_STATE) {
				printTransition(startState, newIndex, inhibitorIndexes);
			}
		}
	}
	
	/**
	 * Given an attractor, determine the index of it with given max tolerance. -1 means could not find it.
	 * @param attractor
	 * @return
	 */
	private static int attractorWhomIam(double[] attractor, double[][] attractors, double maxTolerance) {
		for (int i = 0; i < attractors.length; i++) {
			if (attractor.length != attractors[i].length) {
				continue;
			}
			
			boolean notThisOne = false;
			for (int j = 0; j < attractor.length; j++) {
				if (maxTolerance > 0) {
					if (Math.abs(attractor[j] - attractors[i][j]) > maxTolerance) {
						notThisOne = true;
						break;
					}
				} else { // If the maxTolerance <= 0, we just care its polarity
					if ((attractor[j] - 0.5) * (attractors[i][j] - 0.5) < 0 ) {
						notThisOne = true;
						break;
					}
				}
			}
			
			if (!notThisOne) {
				return i;
			}
		}
		
		return -1;
	}
}
